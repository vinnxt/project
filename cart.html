<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Keranjang - Toko Online</title>
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
    <header class="py-3">
        <div class="container d-flex align-items-center justify-content-between">
            <h1 class="h4">Keranjang Anda</h1>
            <a href="index.html" class="btn btn-outline-secondary">Lanjut Belanja</a>
        </div>
    </header>

    <main class="cart-page">
        <div class="container">
            <div id="cartContainer">
                <!-- Cart will be rendered here -->
            </div>
            <div class="mt-4 d-flex justify-content-end">
                <div class="total-box">
                    <div><strong>Total Terpilih:</strong> <span id="cartTotal">Rp 0</span></div>
                    <div class="mt-3 d-flex gap-2">
                        <button id="buyNowBtn" class="btn-buy">Beli Sekarang</button>
                        <button id="removeSelectedBtn" class="btn btn-outline-danger">Hapus Terpilih</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="py-3">
        <div class="container text-center">&copy; 2025 Toko Online</div>
    </footer>

    <script>
        // Cart page JS: render cart, allow select, qty, remove, buy
        (function(){
            function getCart(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch(e){ return []; } }
            function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
            function updateCartCountSitewide(){ const count = getCart().reduce((s,i)=>s+(i.qty||1),0); try{ const el = parent?.document?.getElementById('cartCount') || document.getElementById('cartCount'); if(el) el.textContent = count; }catch(e){} }

            const container = document.getElementById('cartContainer');

            function formatRp(n){ return 'Rp ' + (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }

            function render(){
                const cart = getCart();
                if(!cart || cart.length === 0){
                    container.innerHTML = '<div class="alert alert-info">Keranjang kosong. <a href="index.html">Belanja sekarang</a></div>';
                    document.getElementById('cartTotal').textContent = formatRp(0);
                    updateCartCountSitewide();
                    return;
                }

                let html = '<table class="cart-table"><thead><tr><th><input type="checkbox" id="selectAll"></th><th>Produk</th><th>Harga</th><th>Jumlah</th><th>Aksi</th></tr></thead><tbody>';
                cart.forEach((it, idx) => {
                    const qty = it.qty || 1;
                    html += `<tr data-index="${idx}">`+
                        `<td><input type="checkbox" class="row-select" ${it.selected !== false ? 'checked' : ''}></td>`+
                        `<td><div class="d-flex gap-3 align-items-center"><img src="${it.img||'assets/tshirt1.jpg'}" class="cart-thumb"> <div><strong>${it.title||'Produk'}</strong></div></div></td>`+
                        `<td>${formatRp(it.price)}</td>`+
                        `<td><div class="qty-controls"><button class="qty-decrease btn-decrease">-</button><span class="qty-val">${qty}</span><button class="qty-increase btn-increase">+</button></div></td>`+
                        `<td><div class="cart-actions"><button class="btn btn-sm btn-outline-danger btn-remove">Hapus</button></div></td>`+
                    `</tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                attachRowHandlers();
                calculateTotal();
                updateCartCountSitewide();
            }

            function attachRowHandlers(){
                const cart = getCart();
                container.querySelectorAll('tbody tr').forEach(row => {
                    const idx = parseInt(row.dataset.index,10);
                    const decrease = row.querySelector('.btn-decrease');
                    const increase = row.querySelector('.btn-increase');
                    const qtyVal = row.querySelector('.qty-val');
                    const removeBtn = row.querySelector('.btn-remove');
                    const checkbox = row.querySelector('.row-select');

                    decrease && decrease.addEventListener('click', ()=>{
                        if((cart[idx].qty||1) > 1) cart[idx].qty = (cart[idx].qty||1) - 1;
                        saveCart(cart); render();
                    });
                    increase && increase.addEventListener('click', ()=>{
                        cart[idx].qty = (cart[idx].qty||1) + 1; saveCart(cart); render();
                    });
                    removeBtn && removeBtn.addEventListener('click', ()=>{ cart.splice(idx,1); saveCart(cart); render(); });
                    checkbox && checkbox.addEventListener('change', function(){ cart[idx].selected = this.checked; saveCart(cart); calculateTotal(); updateCartCountSitewide(); });
                });

                const selectAll = document.getElementById('selectAll');
                if(selectAll){
                    selectAll.addEventListener('change', function(){
                        const cart = getCart();
                        cart.forEach(c=> c.selected = this.checked);
                        saveCart(cart); render();
                    });
                }
            }

            function calculateTotal(){
                const cart = getCart();
                const total = cart.reduce((s,it)=> s + ((it.selected !== false) ? ((it.price||0) * (it.qty||1)) : 0), 0);
                document.getElementById('cartTotal').textContent = formatRp(total);
            }

            // Buttons
            document.getElementById('buyNowBtn').addEventListener('click', function(){
                const cart = getCart();
                const selected = cart.filter(i => i.selected !== false);
                if(!selected || selected.length === 0){ alert('Pilih barang yang ingin dibeli terlebih dahulu.'); return; }
                const total = selected.reduce((s,i)=>s + ((i.price||0)*(i.qty||1)),0);
                // Simulate purchase: remove selected items from cart
                if(!confirm('Konfirmasi pembelian '+selected.length+' item. Total: ' + formatRp(total) + '\nLanjutkan?')) return;
                const remaining = cart.filter(i => i.selected === false);
                saveCart(remaining);
                alert('Terima kasih! Pesanan Anda berhasil diproses.');
                render();
            });

            document.getElementById('removeSelectedBtn').addEventListener('click', function(){
                let cart = getCart();
                cart = cart.filter(i => i.selected === false);
                saveCart(cart);
                render();
            });

            // initial render
            render();
        })();
    </script>
</body>
</html>
